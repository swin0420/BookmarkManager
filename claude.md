# BookmarkManager - Claude Context

macOS SwiftUI app for managing Twitter/X bookmarks with AI-powered features.

## Architecture

```
BookmarkManager/
â”œâ”€â”€ Models/           # Bookmark, Tag, Folder
â”œâ”€â”€ Database/         # SQLite via DatabaseManager
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ ClaudeAPIService    # Claude API + SSE streaming
â”‚   â”œâ”€â”€ RAGService          # Parse â†’ Search â†’ Answer pipeline
â”‚   â”œâ”€â”€ SemanticSearchService
â”‚   â””â”€â”€ EmbeddingService
â”œâ”€â”€ Views/
â”‚   â”œâ”€â”€ AI/           # ChatView, AISettingsView, BatchProcessingView
â”‚   â”œâ”€â”€ SidebarView
â”‚   â”œâ”€â”€ BookmarkGridView
â”‚   â””â”€â”€ FilterBarView
â””â”€â”€ Styles/           # GlassmorphismStyle
```

## Scout Chat (ChatView.swift)

- **Streaming**: SSE via `URLSession.bytes`, batched UI updates (50ms)
- **Follow-ups**: Parsed from `---FOLLOWUPS---` marker in response
- **Inline tweets**: `[TWEET:id]@handle[/TWEET]` â†’ compact preview cards
- **Quick actions**: Add to folder, tag, copy (below source bar)

## ClaudeAPIService

- `sendMessage()` - Single prompt
- `sendConversation()` - Multi-turn
- `streamConversation(onChunk:)` - Real-time streaming

## RAGService

- `parseQuery()` - Extract keywords/dates/authors via Haiku
- `searchBookmarks()` - Keyword + semantic hybrid search
- `ask()` / `askStreaming()` - Full RAG with context injection

## Database (SQLite)

Tables: `bookmarks`, `folders`, `tags`, `bookmark_tags`, `chat_history`, `embeddings`

## UI

- **Theme**: Dark (default), Light, or System - managed via `AppTheme` enum in `AppState`
- **ThemeColors**: Provides adaptive colors based on `colorScheme` (in `GlassmorphismStyle.swift`)
- **Styling**: Purple/cyan gradients, glassmorphism effects
- **App icon**: Bookmark + sparkles

## Theme System

```swift
// AppState manages theme preference (persisted in UserDefaults)
enum AppTheme: String, CaseIterable {
    case system, light, dark
}

// ThemeColors provides adaptive colors
struct ThemeColors {
    let colorScheme: ColorScheme
    var background: Color { ... }      // Dark: #0D0D12, Light: #F5F5F8
    var cardBackground: Color { ... }  // Dark: #141418, Light: white
    var primaryText: Color { ... }     // Dark: white, Light: near-black
    // ... etc
}
```

## Drag and Drop

- Bookmark cards are draggable via `.draggable(bookmark.id)`
- Folders accept drops via `.dropDestination(for: String.self)`
- Drop on folder â†’ moves bookmark to that folder

---

## State Machine Diagrams

### Scout Chat States (ChatView.swift)

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚    IDLE     â”‚
                              â”‚  (Welcome)  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ user sends message
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   PARSING   â”‚
                              â”‚"Understandingâ”‚
                              â”‚   query..."  â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ keywords extracted
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  SEARCHING  â”‚
                              â”‚ "Searching  â”‚
                              â”‚ bookmarks..." â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ sources found
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  THINKING   â”‚
                              â”‚ "Generating â”‚
                              â”‚  answer..." â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ first chunk arrives
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  STREAMING  â”‚
                              â”‚ text appears â”‚
                              â”‚ + cursor    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚ stream complete
                                     â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  COMPLETE   â”‚
                              â”‚ full message â”‚
                              â”‚ + follow-ups â”‚
                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                      â–¼                              â–¼
               [user asks]                    [click follow-up]
               new question                      question
                      â”‚                              â”‚
                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â–¼
                                 PARSING
```

### RAG Pipeline (RAGService.swift)

```
  Question
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    keywords,     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    relevant    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PARSE   â”‚â”€â”€â”€dates, authorsâ”€â–¶â”‚  SEARCH  â”‚â”€â”€â”€â”€bookmarksâ”€â”€â–¶â”‚ CONTEXT  â”‚
â”‚  QUERY   â”‚                  â”‚BOOKMARKS â”‚               â”‚  BUILD   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                              â”‚                         â”‚
  Haiku LLM                   Keyword +                  Format for
                              Semantic                     Claude
                                                             â”‚
                                                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    clean answer  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    stream     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PARSE   â”‚â—€â”€â”€â”€+ follow-upsâ”€â”€â”‚ GENERATE â”‚â—€â”€â”€â”€chunksâ”€â”€â”€â”€â”€â”‚  CALL    â”‚
â”‚ RESPONSE â”‚                  â”‚  ANSWER  â”‚               â”‚  CLAUDE  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
   SAVE HISTORY
```

### Streaming Connection (ClaudeAPIService.swift)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   IDLE     â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ streamConversation() called
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CONNECTING â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚
      â”‚ HTTP 200                â”‚ HTTP 429
      â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STREAMING  â”‚            â”‚RATE LIMITEDâ”‚
â”‚            â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Buffer    â”‚                  â”‚
â”‚    â†“       â”‚                  â–¼
â”‚ parse SSE  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    â†“       â”‚            â”‚   ERROR    â”‚
â”‚ onChunk()  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚ [DONE]
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COMPLETE   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Main Content View States (ContentView.swift)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    IDLE     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ onAppear / filter change
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   LOADING   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ isLoading=  â”‚                                   â”‚
â”‚    true     â”‚                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
       â”‚ fetch complete                           â”‚
       â–¼                                          â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
  â”‚ results â”‚                                     â”‚
  â”‚ empty?  â”‚                                     â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                     â”‚
   YES â”‚    NO                                    â”‚
       â–¼     â–¼                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  EMPTY   â”‚  â”‚ DISPLAY  â”‚                       â”‚
â”‚EmptyStateâ”‚  â”‚BookmarkGrid                      â”‚
â”‚  View    â”‚  â”‚  View    â”‚                       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â”‚
     â”‚             â”‚                              â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                              â”‚
            â”‚ filter/search/sort changes          â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Search Mode Decision:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ isSemanticSearchEnabled                 â”‚
â”‚ AND !searchQuery.isEmpty                â”‚
â”‚ AND selectedSection == .allBookmarks    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            YES  â”‚  NO
                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚SemanticSearchService   â”‚  DatabaseManager
    â”‚.search() (relevance)   â”‚  .searchBookmarks()
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  (sortOrder)
```

### Bookmark View States

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    NORMAL    â”‚
                    â”‚   (browse)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                  â–¼                  â–¼
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ SELECTION  â”‚    â”‚  FILTERED  â”‚    â”‚ SEARCHING  â”‚
  â”‚    MODE    â”‚    â”‚   (folder/ â”‚    â”‚  (query)   â”‚
  â”‚ (bulk ops) â”‚    â”‚    tag)    â”‚    â”‚            â”‚
  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  CONTEXT   â”‚
                   â”‚   MENU     â”‚â”€â”€â–¶ Move / Tag / Favorite / Delete
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Selection Mode Toggle:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     toggle      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ isSelectionMode   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ isSelectionMode   â”‚
â”‚     = false       â”‚                 â”‚     = true        â”‚
â”‚                   â”‚                 â”‚ Show: Move, Tag,  â”‚
â”‚                   â”‚                 â”‚       Delete btns â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                              â”‚
                                      exit or complete
                                              â”‚
                                              â–¼
                                      selectedBookmarkIds
                                          .clear()
```

### Batch Processing States (BatchProcessingView.swift)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    IDLE     â”‚
â”‚             â”‚
â”‚ [Start btn] â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ click "Start Processing"
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VALIDATING  â”‚
â”‚  API key    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
   OK  â”‚  FAIL
       â”‚    â””â”€â”€â”€â–¶ Show error, stay IDLE
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PROCESSING  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚                  â”‚
â”‚ progress:   â”‚    onProgress    â”‚
â”‚ [====>    ] â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ 45/100      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ all items complete
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPLETE   â”‚
â”‚             â”‚
â”‚ âœ“ 95 done   â”‚
â”‚ âœ— 5 errors  â”‚
â”‚             â”‚
â”‚ [Error list]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### AI Settings States (AISettingsView.swift)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    IDLE     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             â”‚                               â”‚
â”‚ onAppear:   â”‚                               â”‚
â”‚ loadKey()   â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                               â”‚
       â”‚                                      â”‚
       â–¼                                      â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
  â”‚has key? â”‚                                 â”‚
  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                 â”‚
   YES â”‚  NO                                  â”‚
       â–¼   â–¼                                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚KEY EXISTSâ”‚  â”‚ NO KEY   â”‚                   â”‚
â”‚sk-ant-â€¢â€¢â€¢â”‚  â”‚[input]   â”‚                   â”‚
â”‚          â”‚  â”‚          â”‚                   â”‚
â”‚[Remove]  â”‚  â”‚[Save]    â”‚                   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                   â”‚
     â”‚             â”‚ click Save              â”‚
     â”‚             â–¼                          â”‚
     â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
     â”‚      â”‚ VALIDATING  â”‚                  â”‚
     â”‚      â”‚   âŸ³         â”‚                  â”‚
     â”‚      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚
     â”‚         OK  â”‚  FAIL                   â”‚
     â”‚             â–¼     â–¼                   â”‚
     â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
     â”‚      â”‚KEY_SAVED â”‚ â”‚KEY_FAILEDâ”‚       â”‚
     â”‚      â”‚ âœ“ Valid  â”‚ â”‚ âœ— Invalidâ”‚       â”‚
     â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚
     â”‚           â”‚            â”‚              â”‚
     â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ click Remove           â”‚
     â–¼                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚ KEY_DELETED â”‚               â”‚
â”‚             â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sidebar States (SidebarView.swift)

```
Section Expansion (independent toggles):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FOLDERS      â”‚    â”‚     TAGS       â”‚    â”‚    SMART       â”‚
â”‚  [â–¼ expanded]  â”‚    â”‚  [â–¼ expanded]  â”‚    â”‚  [â–¶ collapsed] â”‚
â”‚   - Work       â”‚    â”‚   - AI         â”‚    â”‚                â”‚
â”‚   - Personal   â”‚    â”‚   - Code       â”‚    â”‚                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚ click               â”‚ click               â”‚ click
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â–¶ collapsed] â”‚    â”‚  [â–¶ collapsed] â”‚    â”‚  [â–¼ expanded]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   - With Media â”‚
                                            â”‚   - Text Only  â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Embedding Generation:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    IDLE     â”‚
â”‚             â”‚
â”‚[Build Index]â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ click
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GENERATING  â”‚
â”‚             â”‚
â”‚ [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘] â”‚
â”‚  45 / 100   â”‚
â”‚             â”‚
â”‚ onProgress  â”‚â—€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ complete
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  COMPLETE   â”‚â”€â”€â–¶ back to IDLE
â”‚ âœ“ 100 done  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Modal Sheets (mutually exclusive):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IDLE                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼         â–¼        â–¼        â–¼         â–¼          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”
â”‚New    â”‚ â”‚New    â”‚ â”‚AI    â”‚ â”‚Chat  â”‚ â”‚Batch  â”‚ â”‚Clear  â”‚
â”‚Folder â”‚ â”‚Tag    â”‚ â”‚Settngsâ”‚ â”‚View  â”‚ â”‚Processâ”‚ â”‚Confirmâ”‚
â”‚Sheet  â”‚ â”‚Sheet  â”‚ â”‚Sheet â”‚ â”‚Sheet â”‚ â”‚Sheet  â”‚ â”‚Dialog â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”˜
    â”‚         â”‚        â”‚        â”‚         â”‚         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                        dismiss/cancel
                              â”‚
                              â–¼
                           IDLE
```

### Semantic Search Cache States (SemanticSearchService.swift)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CACHE_EXPIRED  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ cachedEmbeddingsâ”‚                             â”‚
â”‚     = nil       â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
         â”‚ search() called                      â”‚
         â–¼                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚   LOADING       â”‚                             â”‚
â”‚ fetch from DB   â”‚                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
         â”‚                                      â”‚
         â–¼                                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     60 seconds elapsed     â”‚
â”‚  CACHE_VALID    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ cachedEmbeddingsâ”‚
â”‚   = [...]       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ timestamp = now â”‚            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
         â”‚ search() within 60s â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”‚ data mutation
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  clearCache()   â”‚â”€â”€â–¶ CACHE_EXPIRED
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Database Import Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   import    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   process   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IDLE   â”‚â”€â”€â”€â”€JSONâ”€â”€â”€â”€â–¶â”‚ IMPORTINGâ”‚â”€â”€â”€â”€eachâ”€â”€â”€â”€â–¶â”‚  UPSERTING  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   bookmark  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                       â”‚
                                                       â–¼
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  notify   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚  DONE    â”‚â”€â”€viewsâ”€â”€â”€â–¶â”‚ REFRESH â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

URL Import Types:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ bookmarkmanager://import?data=<json>                 â”‚
â”‚ bookmarkmanager://import?file=<path>                 â”‚
â”‚ bookmarkmanager://open                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Folder/Tag Item States

```
SidebarFolderItem:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   NORMAL    â”‚
â”‚  [ğŸ“ Work]  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â–¼       â–¼           â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚HOVER â”‚ â”‚DROP  â”‚ â”‚ RENAME  â”‚ â”‚ DELETE  â”‚
â”‚      â”‚ â”‚TARGETâ”‚ â”‚ SHEET   â”‚ â”‚ CONFIRM â”‚
â”‚[pen] â”‚ â”‚glow  â”‚ â”‚[____]   â”‚ â”‚ [Yes/No]â”‚
â”‚[trashâ”‚ â”‚effectâ”‚ â”‚         â”‚ â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Summary Table

| Component | States | Error Handling | Async Operations |
|-----------|--------|----------------|------------------|
| ChatView | IDLE, PARSING, SEARCHING, THINKING, STREAMING, COMPLETE | Empty results | RAGService streaming |
| BatchProcessingView | IDLE, PROCESSING, COMPLETE | Error count + list | AIService.batchSummarize |
| AISettingsView | IDLE, VALIDATING, KEY_SAVED, KEY_FAILED | Validation error msg | ClaudeAPIService.testAPIKey |
| ContentView | IDLE, LOADING, EMPTY, DISPLAY | Empty state view | Database queries |
| SidebarView | IDLE, EMBEDDING_GENERATING, SHEET_ACTIVE | N/A | SemanticSearchService |
| SemanticSearchService | CACHE_VALID, CACHE_EXPIRED | Empty results | Embedding generation |
| ClaudeAPIService | IDLE, CONNECTING, STREAMING, COMPLETE | Rate limit, errors | HTTP streaming |
